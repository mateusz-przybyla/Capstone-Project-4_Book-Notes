<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/main.css" />
    <title>Book notes | <%=title %></title>
  </head>
  <body>
    <h1>Books weâ€™ve read</h1>

    <% if (locals.error){%>
    <p class="error"><%= error %></p>
    <% } %>
    <!-- Users list -->
    <div>
      <% if (locals.users){ %>
      <div class="container" id="users">
        <h2>Who's making notes?</h2>
        <div class="usersList">
          <% if (locals.users){ %> <% for (user of users){ %>
          <form method="POST" action="/user">
            <input
              type="submit"
              name="user"
              value="<%= user.id %>"
              id="<%= user.id %>"
              class="inputHidden"
            />
            <label
              for="<%= user.id %>"
              style="background-color: <%= user.color %>"
              class="tile"
            >
              <%= user.name %>
            </label>
          </form>

          <!-- Delete user form -->
          <form method="POST" action="/user/delete/<%=user.id%>">
            <button id="deleteBtn<%=user.id%>" class="delete">Delete</button>
          </form>
          <!-- end Delete user form -->
          <% } %> <% } %>

          <button id="newUserBtn" class="tile" onclick="openUserForm()">
            + user
          </button>
        </div>

        <!-- Add user form -->
        <form action="/user/add" method="POST" id="newUserForm" hidden>
          <p class="user">What's your name?</p>
          <input type="text" name="name" />

          <p class="user">Pick a color:</p>
          <input type="radio" name="color" id="red" value="red" />
          <label for="red"><span class="red"></span></label>

          <input type="radio" name="color" id="green" value="green" />
          <label for="green"><span class="green"></span></label>

          <input type="radio" name="color" id="yellow" value="yellow" />
          <label for="yellow"><span class="yellow"></span></label>

          <input type="radio" name="color" id="olive" value="olive" />
          <label for="olive"><span class="olive"></span></label>

          <input type="radio" name="color" id="orange" value="orange" />
          <label for="orange"><span class="orange"></span></label>

          <input type="radio" name="color" id="teal" value="indigo" />
          <label for="teal"><span class="teal"></span></label>

          <input type="radio" name="color" id="blue" value="blue" />
          <label for="blue"><span class="blue"></span></label>

          <input type="radio" name="color" id="violet" value="violet" />
          <label for="violet"><span class="violet"></span></label>

          <input type="radio" name="color" id="purple" value="purple" />
          <label for="purple"><span class="purple"></span></label>

          <input type="radio" name="color" id="pink" value="pink" />
          <label for="pink"><span class="pink"></span></label>
          <div class="spacer"></div>
          <button type="submit">Add</button>
          <a href="/user" class="">Back</a>
        </form>
        <!-- end Add user form -->
      </div>
      <% } %>
    </div>
    <!-- end Users list -->
    <!-- Add new book -->
    <% if (locals.books){ %>
    <button id="addBtn" onclick="createNewBook()">+ Book</button>
    <% } %>

    <div>
      <div id="newCover" hidden>
        <h2>Search book cover:</h2>
        <!-- Search cover form -->
        <form method="POST" action="/api/search">
          <input type="text" name="q" placeholder="e.g. Jurassic Park" />
          <button type="submit">Search</button>
        </form>
        <!-- end Search cover form -->
      </div>
      <div class="">
        <!-- Add book form -->
        <form method="POST" action="/book/add">
          <input type="hidden" id="choosenCover" name="choosenCover" value="" />

          <% if (locals.coverIds && coverIds.length > 0){ %>
          <h2>Choose one from the available covers:</h2>
          <% for (coverId of coverIds){ %>
          <img
            onclick="handler('<%= coverId %>')"
            id="cover<%= coverId %>"
            class="covers"
            src="https://covers.openlibrary.org/b/id/<%= coverId %>.jpg"
          />
          <% } %> <br />
          <div class="newBookBox">
            <input type="text" name="title" placeholder="Title" required />
            <input type="text" name="author" placeholder="Author" required />
            <textarea
              type="text"
              name="notes"
              placeholder="Notes"
              rows="3"
              required
            ></textarea>
            <input type="date" name="date" placeholder="Date" required />

            <button type="submit">Add book</button>
            <a href="/user" class="">Back</a>
          </div>
          <% } %>
        </form>
        <!-- end Add book form -->
      </div>
    </div>
    <!-- end Add new book -->
    <!-- Books list -->
    <div>
      <% if (locals.users){ %>
      <div>
        <% if (locals.books){ %> <% for (book of books){ %>
        <div class="booksList">
          <div id="bookData<%=book.id%>">
            <p><%= book.id %></p>
            <p><%= book.title %></p>
            <p><%= book.author %></p>
            <p><%= book.date %></p>
            <p><%= book.notes %></p>
          </div>
          <!-- Edit book data form -->
          <form
            method="POST"
            action="/book/edit/<%=book.id%>"
            id="editForm<%=book.id%>"
            hidden
          >
            <input
              id="editTitle<%=book.id%>"
              class="bookData"
              type="text"
              name="updatedTitle"
              value="<%= book.title %>"
              autocomplete="off"
            />
            <input
              id="editAuthor<%=book.id%>"
              class="bookData"
              type="text"
              name="updatedAuthor"
              value="<%= book.author %>"
              autocomplete="off"
            />
            <input
              id="editDate<%=book.id%>"
              class="bookData"
              type="date"
              name="updatedDate"
              value="<%= book.date %>"
              autocomplete="off"
            />
            <input
              id="editNotes<%=book.id%>"
              class="bookData"
              type="text"
              name="updatedNotes"
              value="<%= book.notes %>"
              autocomplete="off"
            />
            <button id="doneBtn<%=book.id%>" class="edit" type="submit">
              Done
            </button>
            <a href="/user" class="">Back</a>
          </form>
          <!-- end Edit data form -->
          <button
            id="editBtn<%=book.id%>"
            class="edit"
            onclick="editHandler('<%=book.id%>')"
          >
            Edit
          </button>
          <!-- Delete data form -->
          <form method="POST" action="/book/delete/<%=book.id%>">
            <button id="deleteBtn<%=book.id%>" class="delete">Delete</button>
          </form>
          <!-- end Delete data form -->
          <% if (book.cover_id) { %>
          <img
            src="https://covers.openlibrary.org/b/id/<%=book.cover_id%>.jpg"
          />
          <%} else{ %>
          <img
            src="/assets/icons/file-person.svg"
            alt="unknown"
            class="empty"
          /><% } %>

          <hr />
        </div>
        <% } %> <% } %>
      </div>
      <% } %>
    </div>
    <!-- end Books list -->

    <script>
      function handler(id) {
        const convertedIds =
          "<% if (locals.coverIds){%><%= coverIds %><%}%>".split(",");

        var choosenCover = document.getElementById("cover" + id);
        choosenCover.classList.add("frame");
        document.getElementById("choosenCover").value = id;

        setTimeout(function () {
          for (convertedId of convertedIds) {
            if (convertedId !== id) {
              console.log("cover" + convertedId);

              var otherCover = document.getElementById("cover" + convertedId);
              otherCover.setAttribute("hidden", true);
            }
          }
        }, 400);
      }
    </script>
    <script>
      function createNewBook() {
        document.getElementById("addBtn").setAttribute("hidden", true);
        document.getElementById("newCover").removeAttribute("hidden");
      }
    </script>
    <script>
      function editHandler(id) {
        document.getElementById("addBtn").setAttribute("hidden", true);
        document.getElementById("bookData" + id).setAttribute("hidden", true);

        document.getElementById("editBtn" + id).setAttribute("hidden", true);
        document.getElementById("doneBtn" + id).removeAttribute("hidden");

        document.getElementById("editForm" + id).removeAttribute("hidden");
      }
    </script>
    <script>
      function openUserForm() {
        document.getElementById("newUserForm").removeAttribute("hidden");
      }
    </script>
  </body>
</html>
